<%= f.hidden_field :method_name, value: f.object.method_name %>

<% validation_matrix = {
  presence: %w[string text integer float decimal date datetime],
  numericality: %w[integer float decimal],
  uniqueness: %w[string text integer float decimal],
  length: %w[string text],
  format: %w[string],
  inclusion: %w[string text integer float decimal boolean],
  exclusion: %w[string text integer float decimal boolean]
} %>
<% selected_validation = f.object.validation_type.presence || f.object.options.keys.first %>
<% runtime_class = runtime_class_for(f.object.darwin_model) %>
<% attribute_choices = (runtime_class&.columns || []).map { |c| { name: c.name, type: c.type.to_s } } %>

<div data-controller="block-form"
     data-block-form-model-name-value="<%= f.object.darwin_model.to_param %>"
     data-block-form-attribute-type-url-value="<%= attribute_type_model_path(f.object.darwin_model) %>"
     data-block-form-attributes-value="<%= attribute_choices.to_json %>"
     class="space-y-4">
  <%= render "ui/field" do %>
    <%= render "ui/field/label" do %>Attribute<% end %>
    <%= render "ui/field/content" do %>
      <%= render "ui/select",
                  value: f.object.args_name,
                  data: { action: "ui--select:select->block-form#selectAttribute ui--select:change->block-form#selectAttribute" } do %>
        <%= render "ui/select/trigger", placeholder: "Pick an attribute", classes: "w-full" %>
        <%= render "ui/select/content" do %>
          <% attribute_choices.each do |attr| %>
            <%= render "ui/select/item",
                        value: attr[:name],
                        attributes: { data: { value: attr[:name], type: attr[:type], "ui--select-target": "item" }, action: "click->block-form#selectAttribute" } do %>
              <%= attr[:name].humanize %>
            <% end %>
          <% end %>
        <% end %>
        <%= f.hidden_field :args_name,
                            value: f.object.args_name,
                            data: {
                              "ui--select-target": "hiddenInput",
                              "block-form-target": "attributeSelect",
                              action: "change->block-form#populateValidationTypes"
                            } %>
      <% end %>
    <% end %>
  <% end %>

  <%= render "ui/field" do %>
    <%= render "ui/field/label" do %>Validation<% end %>
    <%= render "ui/field/content",
                attributes: { data: { "block-form-target": "validationTypeContainer" } } do %>
      <%= render "ui/select",
                  value: selected_validation,
                  classes: "w-full",
                  data: { action: "ui--select:select->block-form#selectValidation ui--select:change->block-form#selectValidation" } do %>
        <%= render "ui/select/trigger", placeholder: "Select validation" %>
        <%= render "ui/select/content" do %>
          <% validation_matrix.each do |validation, allowed_types| %>
            <%= render "ui/select/item",
                        value: validation,
                        attributes: {
                          data: {
                            allowed_types: allowed_types.join(" "),
                            value: validation,
                            "ui--select-target": "item"
                          },
                          action: "click->block-form#selectValidation"
                        } do %>
              <%= validation.to_s.humanize %>
            <% end %>
          <% end %>
        <% end %>
        <%= f.hidden_field :validation_type,
                            value: selected_validation,
                            data: {
                              "ui--select-target": "hiddenInput",
                              action: "change->block-form#toggleValidationFields"
                            } %>
      <% end %>
    <% end %>
  <% end %>

  <%# Presence Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "presence" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Presence<% end %>
    <%= render "ui/field/content", classes: "flex items-center gap-3" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= render "ui/switch",
                    id: options_form.field_id(:presence),
                    name: options_form.field_name(:presence),
                    checked: opts['presence'] %>
      <% end %>
    <% end %>
    <%= render "ui/field/description", content: "Require this field to be present." %>
  <% end %>

  <%# Numericality Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "numericality" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Numericality<% end %>
    <%= render "ui/field/content", classes: "flex items-center gap-3" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= render "ui/switch",
                    id: options_form.field_id(:numericality),
                    name: options_form.field_name(:numericality),
                    checked: opts['numericality'] %>
      <% end %>
    <% end %>
    <%= render "ui/field/description", content: "Limit to numeric values." %>
  <% end %>

  <%# Uniqueness Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "uniqueness" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Uniqueness<% end %>
    <%= render "ui/field/content", classes: "flex items-center gap-3" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= render "ui/switch",
                    id: options_form.field_id(:uniqueness),
                    name: options_form.field_name(:uniqueness),
                    checked: opts['uniqueness'] %>
      <% end %>
    <% end %>
    <%= render "ui/field/description", content: "Ensure values are unique." %>
  <% end %>

  <%# Length Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "length" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Length<% end %>
    <%= render "ui/field/content" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= options_form.fields_for :length, opts.fetch('length', {}) do |length_form| %>
          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <%= render "ui/input",
                        id: length_form.field_id(:minimum),
                        name: length_form.field_name(:minimum),
                        value: length_form.object.try(:[], 'minimum'),
                        type: "number",
                        placeholder: "Minimum" %>
            <%= render "ui/input",
                        id: length_form.field_id(:maximum),
                        name: length_form.field_name(:maximum),
                        value: length_form.object.try(:[], 'maximum'),
                        type: "number",
                        placeholder: "Maximum" %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <%# Format Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "format" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Format<% end %>
    <%= render "ui/field/content" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= options_form.fields_for :format, opts.fetch('format', {}) do |format_form| %>
          <%= render "ui/input",
                      id: format_form.field_id(:with),
                      name: format_form.field_name(:with),
                      value: format_form.object.try(:[], 'with'),
                      placeholder: "Regex" %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <%# Inclusion Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "inclusion" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Inclusion<% end %>
    <%= render "ui/field/content" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= options_form.fields_for :inclusion, opts.fetch('inclusion', {}) do |inclusion_form| %>
          <%= render "ui/input",
                      id: inclusion_form.field_id(:in),
                      name: inclusion_form.field_name(:in),
                      value: inclusion_form.object.try(:[], 'in')&.join(', '),
                      placeholder: "Comma-separated values" %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <%# Exclusion Validation %>
  <%= render "ui/field",
              attributes: { data: { "block-form-target": "validationField", validation_type: "exclusion" }, style: "display: none;" } do %>
    <%= render "ui/field/label" do %>Exclusion<% end %>
    <%= render "ui/field/content" do %>
      <% opts = f.object.options || {} %>
      <%= f.fields_for :options, opts do |options_form| %>
        <%= options_form.fields_for :exclusion, opts.fetch('exclusion', {}) do |exclusion_form| %>
          <%= render "ui/input",
                      id: exclusion_form.field_id(:in),
                      name: exclusion_form.field_name(:in),
                      value: exclusion_form.object.try(:[], 'in')&.join(', '),
                      placeholder: "Comma-separated values" %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</div>
