<%= form_with(model: @record, url: @record.new_record? ? darwin.records_path(@model.name.pluralize.underscore) : darwin.record_path(@model.name.pluralize.underscore, @record)) do |form| %>
  <% if @record.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@record.errors.count, "error") %> prohibited this record from being saved:</h2>

      <ul>
        <% @record.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% @model.runtime_constant.columns.each do |column| %>
    <% next if column.name == 'id' || column.name == 'created_at' || column.name == 'updated_at' %>
    <%# Foreign keys for belongs_to associations are handled separately %>
    <% next if @model.runtime_constant.reflect_on_all_associations(:belongs_to).map(&:foreign_key).include?(column.name) %>

    <div class="field">
      <%= form.label column.name.to_sym %>
      <%= case column.type
          when :string
            form.text_field column.name.to_sym
          when :text
            form.text_area column.name.to_sym
          when :integer, :float, :decimal
            form.number_field column.name.to_sym
          when :boolean
            form.check_box column.name.to_sym
          when :date
            form.date_field column.name.to_sym
          when :datetime
            form.datetime_field column.name.to_sym
          else
            form.text_field column.name.to_sym
          end %>
    </div>
  <% end %>

  <%# Belongs to associations %>
  <% @model.runtime_constant.reflect_on_all_associations(:belongs_to).each do |association| %>
    <div class="field">
      <%= form.label association.foreign_key, association.name.to_s.humanize %>
      <%= form.collection_select(association.foreign_key, association.klass.all, :id, :to_s, prompt: "Select #{association.name.to_s.humanize}") %>
    </div>
  <% end %>

  <%# Has many associations %>
  <% @model.runtime_constant.reflect_on_all_associations(:has_many).each do |association| %>
    <%# Only render nested forms for associations that accept nested attributes %>
    <% next unless @model.runtime_constant.nested_attributes_options.key?(association.name) %>

    <div data-controller="nested-form">
      <h3><%= association.name.to_s.humanize %></h3>
      <template data-nested-form-target="template">
        <%= form.fields_for association.name, association.klass.new, child_index: 'NEW_RECORD' do |f| %>
          <%= render 'nested_association_fields', form: f, association: association %>
        <% end %>
      </template>

      <div data-nested-form-target="target">
        <%= form.fields_for association.name do |f| %>
          <%= render 'nested_association_fields', form: f, association: association %>
        <% end %>
      </div>

      <div class="actions">
        <%= link_to "Add #{association.name.to_s.singularize.humanize}", "#", class: "btn btn-primary", data: { action: "nested-form#add" } %>
      </div>
    </div>
  <% end %>

  <div class="actions">
    <%= form.submit @record.new_record? ? "Create Record" : "Update Record" %>
  </div>
<% end %>