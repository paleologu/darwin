<%= form_with(model: @record, url: @record.new_record? ? darwin.records_path(@model.collection_param) : darwin.record_path(@model.collection_param, @record)) do |form| %>
  <div class="space-y-6">
    <% if @record.errors.any? %>
      <%= render "ui/alert", variant: :destructive do %>
        <%= render "ui/alert/title" do %>
          <%= pluralize(@record.errors.count, "error") %> prohibited this record from being saved
        <% end %>
        <%= render "ui/alert/description" do %>
          <%= render "ui/list", classes: "text-destructive" do %>
            <% @record.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>

    <% runtime = @runtime_class || runtime_class_for(@model) %>

    <div class="space-y-4">
      <% runtime.columns.each do |column| %>
        <% next if column.name == 'id' || column.name == 'created_at' || column.name == 'updated_at' %>
        <% next if runtime.reflect_on_all_associations(:belongs_to).map(&:foreign_key).include?(column.name) %>

        <% field_id = form.field_id(column.name.to_sym) %>
        <% field_name = form.field_name(column.name.to_sym) %>
        <%= render "ui/field" do %>
          <%= render "ui/field/label", for_id: field_id do %><%= column.name.humanize %><% end %>
          <%= render "ui/field/content" do %>
            <% case column.type
               when :string
                 concat(render("ui/input", id: field_id, name: field_name, value: form.object.send(column.name)))
               when :text
                 concat(render("ui/textarea", id: field_id, name: field_name, value: form.object.send(column.name), rows: 3))
               when :integer, :float, :decimal
                 concat(render("ui/input", id: field_id, name: field_name, value: form.object.send(column.name), type: "number"))
               when :boolean
                 concat(render("ui/switch", name: field_name, id: field_id, checked: form.object.send(column.name)))
               when :date
                 concat(render("ui/input", id: field_id, name: field_name, value: form.object.send(column.name), type: "date"))
               when :datetime
                 concat(render("ui/input", id: field_id, name: field_name, value: form.object.send(column.name)&.strftime("%Y-%m-%dT%H:%M"), type: "datetime-local"))
               else
                 concat(render("ui/input", id: field_id, name: field_name, value: form.object.send(column.name)))
               end %>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <%# Belongs to associations %>
    <div class="space-y-4">
      <% runtime.reflect_on_all_associations(:belongs_to).each do |association| %>
        <% field_id = form.field_id(association.foreign_key) %>
        <% field_name = form.field_name(association.foreign_key) %>
        <% options = association.klass.all %>
        <%= render "ui/field" do %>
          <%= render "ui/field/label", for_id: field_id do %><%= association.name.to_s.humanize %><% end %>
          <%= render "ui/field/content" do %>
            <%= render "ui/select", value: form.object.send(association.foreign_key) do %>
              <%= render "ui/select/trigger", placeholder: "Select #{association.name.to_s.humanize}", classes: "w-full" %>
              <%= render "ui/select/content" do %>
                <% options.each do |option| %>
                  <%= render "ui/select/item", value: option.id do %><%= option.to_s %><% end %>
                <% end %>
              <% end %>
              <%= form.hidden_field association.foreign_key,
                                    data: { "ui--select-target": "hiddenInput" },
                                    value: form.object.send(association.foreign_key) %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <%# Has many associations %>
    <% runtime.reflect_on_all_associations(:has_many).each do |association| %>
      <% next unless runtime.nested_attributes_options.key?(association.name) %>

      <%= render "ui/card", classes: "space-y-4", attributes: { data: { controller: "nested-form" } } do %>
        <%= render "ui/card/header", classes: "flex items-center justify-between" do %>
          <%= render "ui/card/title", content: association.name.to_s.humanize %>
          <%= render "ui/button", variant: "outline", type: "button", attributes: { data: { action: "nested-form#add" } } do %>
            Add <%= association.name.to_s.singularize.humanize %>
          <% end %>
        <% end %>

        <%= render "ui/card/content", classes: "space-y-4" do %>
          <template data-nested-form-target="template">
            <%= form.fields_for association.name, association.klass.new, child_index: 'NEW_RECORD' do |f| %>
              <%= render 'nested_association_fields', form: f, association: association %>
            <% end %>
          </template>

          <div data-nested-form-target="target" class="space-y-4">
            <%= form.fields_for association.name do |f| %>
              <%= render 'nested_association_fields', form: f, association: association %>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <div class="flex justify-end gap-3">
      <%= render "ui/navigation_menu/link", href: darwin.records_path(@model.collection_param), trigger_style: true do %>
        Cancel
      <% end %>
      <% if @record.persisted? %>
        <%= render "ui/navigation_menu/link", href: darwin.record_path(@model.collection_param, @record), trigger_style: true do %>
          Show
        <% end %>
      <% end %>
      <%= render "ui/button", type: "submit" do %>
        <%= @record.new_record? ? "Create Record" : "Update Record" %>
      <% end %>
    </div>
  </div>
<% end %>
